# Data Layer - Local Development Docker Compose
# Includes: Redpanda (Kafka), FalkorDB (Graph), Valkey (Cache), Cognee Worker
version: '3.8'

services:
  # =============================================================================
  # Redpanda - Kafka-compatible streaming platform (single node for dev)
  # =============================================================================
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.2.4
    container_name: argus-redpanda
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=info
    ports:
      - "9092:9092"      # Kafka API (internal)
      - "19092:19092"    # Kafka API (external)
      - "8081:8081"      # Schema Registry (internal)
      - "18081:18081"    # Schema Registry (external)
      - "8082:8082"      # Pandaproxy (internal)
      - "18082:18082"    # Pandaproxy (external)
      - "9644:9644"      # Admin API
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - argus-data-network

  # =============================================================================
  # Redpanda Console - Web UI for Kafka management
  # =============================================================================
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v2.7.0
    container_name: argus-redpanda-console
    ports:
      - "8080:8080"
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]
          schemaRegistry:
            enabled: true
            urls: ["http://redpanda:8081"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
    depends_on:
      redpanda:
        condition: service_healthy
    networks:
      - argus-data-network

  # =============================================================================
  # FalkorDB - Graph database for knowledge graphs (Redis-compatible)
  # =============================================================================
  falkordb:
    image: falkordb/falkordb:latest
    container_name: argus-falkordb
    ports:
      - "6379:6379"
    environment:
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-argus_dev_password}
    command: >
      --requirepass ${FALKORDB_PASSWORD:-argus_dev_password}
      --maxmemory 2gb
      --maxmemory-policy noeviction
      --appendonly yes
    volumes:
      - falkordb-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${FALKORDB_PASSWORD:-argus_dev_password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - argus-data-network

  # =============================================================================
  # Valkey - Redis-compatible cache (port 6380 to avoid FalkorDB conflict)
  # =============================================================================
  valkey:
    image: valkey/valkey:8.0-alpine
    container_name: argus-valkey
    ports:
      - "6380:6379"
    environment:
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:-argus_cache_password}
    command: >
      valkey-server
      --requirepass ${VALKEY_PASSWORD:-argus_cache_password}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    volumes:
      - valkey-data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "-a", "${VALKEY_PASSWORD:-argus_cache_password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - argus-data-network

  # =============================================================================
  # Cognee Worker - Processes codebase analysis and knowledge graph construction
  # =============================================================================
  cognee-worker:
    build:
      context: ../../
      dockerfile: data-layer/docker/Dockerfile.cognee-worker
    container_name: argus-cognee-worker
    environment:
      # Kafka/Redpanda Configuration
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - KAFKA_CONSUMER_GROUP=argus-cognee-workers
      - KAFKA_AUTO_OFFSET_RESET=earliest

      # FalkorDB Configuration
      - FALKORDB_HOST=falkordb
      - FALKORDB_PORT=6379
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-argus_dev_password}

      # Valkey/Cache Configuration
      - VALKEY_HOST=valkey
      - VALKEY_PORT=6379
      - VALKEY_PASSWORD=${VALKEY_PASSWORD:-argus_cache_password}

      # Cognee Configuration
      - COGNEE_LOG_LEVEL=${COGNEE_LOG_LEVEL:-INFO}
      - COGNEE_DATA_ROOT=/app/data
      - COGNEE_SYSTEM_ROOT=/app/data/.cognee_system
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-claude-sonnet-4-5}

      # BYOK Support (Supabase + Cloudflare Key Vault)
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY:-}
      - CLOUDFLARE_WORKER_URL=${CLOUDFLARE_WORKER_URL:-https://argus-api.heyargus.workers.dev}

      # Worker Configuration
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}
      - WORKER_BATCH_SIZE=${WORKER_BATCH_SIZE:-10}
    volumes:
      - cognee-data:/app/data
      - cognee-logs:/app/logs
    depends_on:
      redpanda:
        condition: service_healthy
      falkordb:
        condition: service_healthy
      valkey:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import cognee; print('healthy')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - argus-data-network

# =============================================================================
# Networks
# =============================================================================
networks:
  argus-data-network:
    driver: bridge
    name: argus-data-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redpanda-data:
    name: argus-redpanda-data
  falkordb-data:
    name: argus-falkordb-data
  valkey-data:
    name: argus-valkey-data
  cognee-data:
    name: argus-cognee-data
  cognee-logs:
    name: argus-cognee-logs
