# Neo4j Aura Schema Initialization Job
# Runs the schema initialization script to create constraints and indexes
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: neo4j-schema-init-script
  namespace: argus-data
  labels:
    app.kubernetes.io/name: neo4j-schema-init
    app.kubernetes.io/part-of: argus
    app.kubernetes.io/component: database
data:
  init_schema.py: |
    #!/usr/bin/env python3
    """
    Neo4j Aura Schema Initialization Script (Kubernetes version)
    Creates constraints and indexes for multi-tenant schema.
    """
    import os
    import sys
    import time

    from neo4j import GraphDatabase
    from neo4j.exceptions import ServiceUnavailable, ClientError

    # Schema definitions
    UNIQUENESS_CONSTRAINTS = [
        ("Organization", "id"), ("Project", "id"), ("Repository", "id"),
        ("CodeFile", "id"), ("Function", "id"), ("Class", "id"),
        ("TestSuite", "id"), ("TestCase", "id"), ("TestRun", "id"),
        ("TestFailure", "id"), ("HealingPattern", "id"), ("CogneeDocument", "id"),
    ]

    EXISTENCE_CONSTRAINTS = [
        ("Project", "org_id"), ("Repository", "org_id"), ("CodeFile", "org_id"),
        ("Function", "org_id"), ("Class", "org_id"), ("TestSuite", "org_id"),
        ("TestCase", "org_id"), ("TestRun", "org_id"), ("TestFailure", "org_id"),
        ("HealingPattern", "org_id"), ("CogneeDocument", "org_id"),
    ]

    COMPOSITE_INDEXES = [
        ("Organization", ["name"]),
        ("Project", ["org_id"]), ("Project", ["org_id", "name"]),
        ("Repository", ["org_id"]), ("Repository", ["org_id", "project_id"]),
        ("CodeFile", ["org_id"]), ("CodeFile", ["org_id", "project_id"]),
        ("CodeFile", ["org_id", "path"]), ("CodeFile", ["org_id", "language"]),
        ("Function", ["org_id"]), ("Function", ["org_id", "project_id"]),
        ("Class", ["org_id"]), ("Class", ["org_id", "project_id"]),
        ("TestSuite", ["org_id"]), ("TestSuite", ["org_id", "project_id"]),
        ("TestCase", ["org_id"]), ("TestCase", ["org_id", "project_id"]),
        ("TestCase", ["org_id", "status"]),
        ("TestRun", ["org_id"]), ("TestRun", ["org_id", "project_id"]),
        ("TestFailure", ["org_id"]), ("TestFailure", ["org_id", "healed"]),
        ("HealingPattern", ["org_id"]), ("HealingPattern", ["org_id", "success_rate"]),
    ]

    FULLTEXT_INDEXES = [
        ("code_search", ["Function", "Class"], ["name", "docstring", "signature"]),
        ("error_search", ["TestFailure"], ["error_message", "stack_trace"]),
        ("file_search", ["CodeFile"], ["path", "name"]),
    ]

    def main():
        uri = os.environ.get("NEO4J_URI")
        username = os.environ.get("NEO4J_USERNAME", "neo4j")
        password = os.environ.get("NEO4J_PASSWORD")

        if not uri or not password:
            print("ERROR: NEO4J_URI and NEO4J_PASSWORD required")
            sys.exit(1)

        print(f"Connecting to Neo4j: {uri[:30]}...")
        driver = GraphDatabase.driver(uri, auth=(username, password))

        # Retry for Aura cold starts
        for attempt in range(1, 6):
            try:
                with driver.session() as session:
                    session.run("RETURN 1")
                print("Connected to Neo4j Aura")
                break
            except ServiceUnavailable:
                if attempt < 5:
                    print(f"  Aura waking up (attempt {attempt}/5), waiting 15s...")
                    time.sleep(15)
                else:
                    print("ERROR: Failed to connect")
                    sys.exit(1)

        errors = 0

        # Create uniqueness constraints
        print("\n=== Creating Uniqueness Constraints ===")
        for label, prop in UNIQUENESS_CONSTRAINTS:
            name = f"{label.lower()}_{prop.lower()}_unique"
            cypher = f"CREATE CONSTRAINT {name} IF NOT EXISTS FOR (n:{label}) REQUIRE n.{prop} IS UNIQUE"
            try:
                with driver.session() as session:
                    session.run(cypher)
                print(f"  {label}.{prop} IS UNIQUE: OK")
            except ClientError as e:
                if "already exists" in str(e).lower():
                    print(f"  {label}.{prop} IS UNIQUE: exists")
                else:
                    print(f"  {label}.{prop}: ERROR - {e}")
                    errors += 1

        # Create existence constraints
        print("\n=== Creating Existence Constraints ===")
        for label, prop in EXISTENCE_CONSTRAINTS:
            name = f"{label.lower()}_{prop.lower()}_exists"
            cypher = f"CREATE CONSTRAINT {name} IF NOT EXISTS FOR (n:{label}) REQUIRE n.{prop} IS NOT NULL"
            try:
                with driver.session() as session:
                    session.run(cypher)
                print(f"  {label}.{prop} IS NOT NULL: OK")
            except ClientError as e:
                if "already exists" in str(e).lower():
                    print(f"  {label}.{prop} IS NOT NULL: exists")
                else:
                    print(f"  {label}.{prop}: ERROR - {e}")
                    errors += 1

        # Create composite indexes
        print("\n=== Creating Composite Indexes ===")
        for label, props in COMPOSITE_INDEXES:
            name = f"{label.lower()}_{'_'.join(p.lower() for p in props)}_idx"
            props_str = ", ".join(f"n.{p}" for p in props)
            cypher = f"CREATE INDEX {name} IF NOT EXISTS FOR (n:{label}) ON ({props_str})"
            try:
                with driver.session() as session:
                    session.run(cypher)
                print(f"  {label}({', '.join(props)}): OK")
            except ClientError as e:
                if "already exists" in str(e).lower():
                    print(f"  {label}({', '.join(props)}): exists")
                else:
                    print(f"  {label}({', '.join(props)}): ERROR - {e}")
                    errors += 1

        # Create full-text indexes
        print("\n=== Creating Full-Text Indexes ===")
        for name, labels, props in FULLTEXT_INDEXES:
            labels_str = "|".join(labels)
            props_str = ", ".join(f"n.{p}" for p in props)
            cypher = f"CREATE FULLTEXT INDEX {name} IF NOT EXISTS FOR (n:{labels_str}) ON EACH [{props_str}]"
            try:
                with driver.session() as session:
                    session.run(cypher)
                print(f"  {name}: OK")
            except ClientError as e:
                if "already exists" in str(e).lower():
                    print(f"  {name}: exists")
                else:
                    print(f"  {name}: ERROR - {e}")
                    errors += 1

        # Verify
        print("\n=== Schema Summary ===")
        with driver.session() as session:
            result = session.run("SHOW CONSTRAINTS")
            print(f"  Total constraints: {len(list(result))}")
            result = session.run("SHOW INDEXES")
            print(f"  Total indexes: {len(list(result))}")

        driver.close()
        print(f"\nErrors: {errors}")
        sys.exit(0 if errors == 0 else 1)

    if __name__ == "__main__":
        main()
---
# Job to initialize the schema
apiVersion: batch/v1
kind: Job
metadata:
  name: neo4j-schema-init
  namespace: argus-data
  labels:
    app.kubernetes.io/name: neo4j-schema-init
    app.kubernetes.io/part-of: argus
    app.kubernetes.io/component: database
  annotations:
    # Use with ArgoCD/Flux for GitOps
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  backoffLimit: 3
  activeDeadlineSeconds: 600  # 10 minute timeout
  ttlSecondsAfterFinished: 86400  # Clean up after 24 hours
  template:
    metadata:
      labels:
        app.kubernetes.io/name: neo4j-schema-init
    spec:
      restartPolicy: OnFailure
      containers:
        - name: schema-init
          image: python:3.12-slim
          command:
            - /bin/sh
            - -c
            - |
              pip install --quiet neo4j && python /scripts/init_schema.py
          env:
            - name: NEO4J_URI
              valueFrom:
                secretKeyRef:
                  name: argus-data-secrets
                  key: neo4j-uri
            - name: NEO4J_USERNAME
              valueFrom:
                secretKeyRef:
                  name: argus-data-secrets
                  key: neo4j-username
            - name: NEO4J_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: argus-data-secrets
                  key: neo4j-password
          volumeMounts:
            - name: scripts
              mountPath: /scripts
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
      volumes:
        - name: scripts
          configMap:
            name: neo4j-schema-init-script
            defaultMode: 0755
