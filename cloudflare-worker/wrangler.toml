# Argus - AI-Powered Browser Automation API
# https://heyargus.ai
# Deploy with: npm run deploy

name = "argus-api"
main = "src/index.ts"
compatibility_flags = ["nodejs_compat"]
compatibility_date = "2025-09-17"

# Enable observability for debugging
[observability]
enabled = true

# Browser Rendering binding (Cloudflare's free browser - Chromium only)
[browser]
binding = "BROWSER"

# Workers AI binding (free tier AI for natural language processing)
[ai]
binding = "AI"

# Vectorize - Vector database for semantic pattern matching
# Create index with: wrangler vectorize create argus-patterns --dimensions=768 --metric=cosine
[[vectorize]]
binding = "VECTOR_INDEX"
index_name = "argus-patterns"

# ============================================================================
# KV Namespaces - Fast key-value storage for caching
# Create with: wrangler kv:namespace create "ARGUS_CACHE"
# ============================================================================
[[kv_namespaces]]
binding = "CACHE"
id = "PLACEHOLDER_CACHE_ID"  # Replace after running: wrangler kv:namespace create "ARGUS_CACHE"

# KV key patterns:
# - dedup:{fingerprint}          → Event deduplication (TTL: 24h)
# - session:{id}                 → User sessions (TTL: 24h)
# - api:quality:{project_id}     → Quality score cache (TTL: 5min)
# - llm:{hash}                   → LLM response cache (TTL: 7d)
# - rate:{project}:{minute}      → Rate limiting (TTL: 2min)
# - webhook:sig:{hash}           → Webhook signature validation (TTL: 1h)

# ============================================================================
# R2 Storage - Object storage for artifacts
# Create with: wrangler r2 bucket create argus-artifacts
# ============================================================================
[[r2_buckets]]
binding = "ARTIFACTS"
bucket_name = "argus-artifacts"

# R2 key patterns:
# - screenshots/{project_id}/{timestamp}.png
# - coverage/{project_id}/{commit_sha}/lcov.info
# - test-results/{project_id}/{run_id}/results.json
# - generated-tests/{project_id}/{timestamp}/{file}.spec.ts

# ============================================================================
# Queues - Async event processing
# Create with: wrangler queues create argus-events
# ============================================================================
[[queues.producers]]
binding = "EVENT_QUEUE"
queue = "argus-events"

# Consumer configuration (process events asynchronously)
[[queues.consumers]]
queue = "argus-events"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "argus-events-dlq"

# Dead letter queue for failed events
[[queues.producers]]
binding = "DLQ"
queue = "argus-events-dlq"

# ============================================================================
# Hyperdrive - Database connection pooling for Supabase
# Create with: wrangler hyperdrive create argus-db --connection-string="postgresql://..."
# ============================================================================
[[hyperdrive]]
binding = "DB"
id = "PLACEHOLDER_HYPERDRIVE_ID"  # Replace after creating hyperdrive config

# ============================================================================
# Durable Objects - Stateful real-time connections
# ============================================================================
[[durable_objects.bindings]]
name = "REALTIME"
class_name = "RealtimeSession"

[[migrations]]
tag = "v1"
new_classes = ["RealtimeSession"]

# Environment variables (non-sensitive)
[vars]
ENVIRONMENT = "production"
DEFAULT_MODEL_PROVIDER = "anthropic"  # "workers-ai", "openai", "anthropic"
ENABLE_CACHING = "true"
ENABLE_SELF_HEALING = "true"
DEFAULT_BACKEND = "auto"  # "auto", "cloudflare", "testingbot"

# Module aliasing for Playwright compatibility
[alias]
playwright = "@cloudflare/playwright"

# Secrets (set via `wrangler secret put <NAME>`):
#
# Required for TestingBot (cross-browser + real devices):
# - TESTINGBOT_KEY (your TestingBot API key)
# - TESTINGBOT_SECRET (your TestingBot API secret)
#
# Optional for external AI providers:
# - OPENAI_API_KEY (if using OpenAI)
# - ANTHROPIC_API_KEY (if using Anthropic)
#
# Optional for API authentication:
# - API_TOKEN (for authenticating incoming requests)
#
# Quality Intelligence Platform:
# - SUPABASE_URL (your Supabase project URL)
# - SUPABASE_SERVICE_KEY (your Supabase service role key)
# - SENTRY_CLIENT_SECRET (for verifying Sentry webhooks - optional)
# - DATADOG_WEBHOOK_TOKEN (for verifying Datadog webhooks - optional)
# - GITHUB_TOKEN (for creating PRs with generated tests)
