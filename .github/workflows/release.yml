name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr: ${{ steps.release.outputs.pr }}
    steps:
      - name: Run release-please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Log release outputs
        env:
          RELEASE_CREATED: ${{ steps.release.outputs.release_created }}
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          VERSION: ${{ steps.release.outputs.version }}
          PR_NUMBER: ${{ steps.release.outputs.pr }}
        run: |
          echo "Release created: ${RELEASE_CREATED:-false}"
          echo "Tag: ${TAG_NAME:-none}"
          echo "Version: ${VERSION:-none}"
          echo "PR: ${PR_NUMBER:-none}"

      # Auto-merge release PRs (no review required for automated releases)
      - name: Enable auto-merge for release PR
        if: ${{ steps.release.outputs.pr }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.release.outputs.pr }}
        run: |
          echo "Enabling auto-merge for PR #${PR_NUMBER}"
          gh pr merge ${PR_NUMBER} --auto --squash --repo ${{ github.repository }} || echo "Auto-merge may already be enabled or PR is not mergeable yet"

  # Build and test on release
  build-on-release:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]" || pip install -e .
          pip install pytest pytest-asyncio pytest-cov httpx

      - name: Run tests
        run: |
          python -m pytest tests/api/test_server.py -v --tb=short
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Build Docker image
        env:
          VERSION: ${{ needs.release-please.outputs.version }}
        run: |
          docker build -t argus-backend:${VERSION} .

      - name: Create release summary
        env:
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
          VERSION: ${{ needs.release-please.outputs.version }}
        run: |
          echo "## Argus Backend Release ${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Railway will automatically deploy this release to production." >> $GITHUB_STEP_SUMMARY

  # Notify on release
  notify-release:
    needs: [release-please, build-on-release]
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Log release info
        env:
          VERSION: ${{ needs.release-please.outputs.version }}
          TAG_NAME: ${{ needs.release-please.outputs.tag_name }}
        run: |
          echo "Released argus-backend@${VERSION}"
          echo "Tag: ${TAG_NAME}"
          echo "Railway deployment will be triggered automatically"
